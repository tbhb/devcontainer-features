---
name: Test features

on:
  pull_request:
    paths:
      - 'src/**'
      - 'test/**'
      - '.github/workflows/test.yaml'
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'test/**'
      - '.github/workflows/test.yaml'
  workflow_dispatch:

jobs:
  detect-features:
    runs-on: ubuntu-latest
    outputs:
      features: ${{ steps.detect.outputs.features }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Detect features
        id: detect
        run: |
          features=$(find src -maxdepth 1 -mindepth 1 -type d -printf '%f\n' \
            | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "features=${features}" >> "$GITHUB_OUTPUT"

  test:
    needs: detect-features
    runs-on: ubuntu-latest
    if: ${{ needs.detect-features.outputs.features != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        feature: ${{ fromJson(needs.detect-features.outputs.features) }}
        base-image:
          - mcr.microsoft.com/devcontainers/base:ubuntu
          - mcr.microsoft.com/devcontainers/base:debian
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Test ${{ matrix.feature }} on ${{ matrix.base-image }}
        run: |
          devcontainer features test \
            --skip-scenarios \
            -f ${{ matrix.feature }} \
            -i ${{ matrix.base-image }} \
            .

  test-scenarios:
    needs: detect-features
    runs-on: ubuntu-latest
    if: ${{ needs.detect-features.outputs.features != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        feature: ${{ fromJson(needs.detect-features.outputs.features) }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Test ${{ matrix.feature }} scenarios
        run: |
          devcontainer features test \
            -f ${{ matrix.feature }} \
            --skip-autogenerated \
            --skip-duplicated \
            .

  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Validate feature metadata
        run: |
          for feature in src/*/; do
            echo "Validating ${feature}..."
            if [[ ! -f "${feature}devcontainer-feature.json" ]]; then
              echo "ERROR: Missing devcontainer-feature.json in ${feature}"
              exit 1
            fi
            if [[ ! -f "${feature}install.sh" ]]; then
              echo "ERROR: Missing install.sh in ${feature}"
              exit 1
            fi
            jq empty "${feature}devcontainer-feature.json"
          done

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install uv
        uses: astral-sh/setup-uv@e58605a9b6da7c637471fab8847a5e5a6b8df081 # v5

      - name: Install dependencies
        run: uv sync --frozen

      - name: Lint YAML
        run: uv run yamllint --strict .

      - name: Lint shell scripts
        run: shellcheck src/*/install.sh test/*/*.sh

      - name: Lint GitHub Actions workflows
        uses: raven-actions/actionlint@e01d1ea33dd6a5ed517d95b4c0c357560ac6f518 # v2

      - name: Check spelling
        run: uv run codespell
